@model InternalProj.ViewModel.WorkOrderViewModel

@{
    ViewBag.Title = "View Work Orders";
    var slno = (Model.CurrentPage - 1) * 10 + 1;
}
<div class="vw-root">
    <!-- Sidebar -->
    <aside class="vw-sidenav">
        <div class="vw-sidenav-brand">Reports</div>
        <a class="vw-sidenav-link active" asp-controller="ViewWork" asp-action="Index">
            <span>Work Order Reports</span>
        </a>
        <!-- Additional nav items if needed -->
    </aside>

    <div class="vw-main">
        <div class="vw-content-card">
            <h2 class="vw-title">Work Order Details</h2>
            <form asp-action="Index" method="post" autocomplete="off" class="vw-form">
                <div class="vw-form-row">
                    <div class="vw-form-group">
                        <label for="studio">Studio</label>
                        <select id="studio" name="studio" class="select2">
                            <option value="">-- Select Studio --</option>
                            @foreach (var studio in Model.StudioList)
                            {
                                if (studio == Model.StudioFilter)
                                {
                                    <option value="@studio" selected>@studio</option>
                                }
                                else
                                {
                                    <option value="@studio">@studio</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="vw-form-group">
                        <label for="fromDate">From Date</label>
                        <input type="date" id="fromDate" name="fromDate" value="@(Model.FromDateFilter?.ToString("yyyy-MM-dd"))" />
                    </div>
                    <div class="vw-form-group">
                        <label for="toDate">To Date</label>
                        <input type="date" id="toDate" name="toDate" value="@(Model.ToDateFilter?.ToString("yyyy-MM-dd"))" />
                    </div>
                    <div class="vw-form-group">
                        <label for="workTypeId">Work Type</label>
                        <select asp-for="WorkTypeFilter" asp-items="@(new SelectList(Model.WorkTypes, "WorkTypeId", "TypeName"))" name="workTypeId">
                            <option value="">-- Select Work Type --</option>
                        </select>
                    </div>
                    <div class="vw-form-group vw-form-group-btn">
                        <button type="submit" class="vw-btn">Search</button>
                    </div>
                </div>
            </form>

            @if (Model.Results != null && Model.Results.Any())
            {
                <div class="vw-table-scroll">
                    <table class="vw-table">
                        <thead>
                            <tr>
                                <th>Work Order No</th>
                                <th>Studio Name</th>
                                <th>Work Type</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Advance</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Results)
                            {
                                <tr>
                                    <td>
                                        <a href="#" class="workorder-link" data-id="@item.WorkOrderId">
                                            @item.WorkOrderNo
                                        </a>
                                    </td>
                                    <td>@item.Customer?.StudioName</td>
                                    <td>@item.WorkType?.TypeName</td>
                                    <td>@item.Wdate?.ToString("dd-MM-yyyy")</td>
                                    <td>@item.SubTotal.ToString("N2")</td>
                                    <td>@item.Advance?.ToString("N2")</td>
                                    <td>@((item.SubTotal - (item.Advance ?? 0)).ToString("N2"))</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Download Dropdown -->
                <div class="export-dropdown" style="display: flex; justify-content: flex-end; margin-top: 16px;">
                    <form method="post" asp-controller="ViewWork" target="_blank" id="downloadForm">
                        <input type="hidden" name="studio" value="@Model.StudioFilter" />
                        <input type="hidden" name="fromDate" value="@(Model.FromDateFilter?.ToString("yyyy-MM-dd"))" />
                        <input type="hidden" name="toDate" value="@(Model.ToDateFilter?.ToString("yyyy-MM-dd"))" />
                        <input type="hidden" name="workTypeId" value="@Model.WorkTypeFilter" />
                        <input type="hidden" name="format" id="downloadFormat" value="" />

                        <div class="dropdown">
                            <button class="vw-btn dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Download
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
                                <li><a class="dropdown-item" href="#" data-format="pdf">Download PDF</a></li>
                                <li><a class="dropdown-item" href="#" data-format="excel">Download Excel</a></li>
                            </ul>
                        </div>
                    </form>
                </div>

        @if (Model.TotalPages > 1)
        {
            <div class="pagination-container">
                <form asp-action="Index" method="post" class="pagination-form">
                    <input type="hidden" name="studio" value="@Context.Request.Form["studio"]" />
                    <input type="hidden" name="fromDate" value="@Context.Request.Form["fromDate"]" />
                    <input type="hidden" name="toDate" value="@Context.Request.Form["toDate"]" />
                    <input type="hidden" name="workTypeId" value="@Context.Request.Form["workTypeId"]" />

                    <div class="pagination-buttons">
                        @if (Model.CurrentPage > 1)
                        {
                            <button name="currentPage" value="@(Model.CurrentPage - 1)" class="pagination-btn">&lt;</button>
                        }
                        <button name="currentPage" value="1" class="pagination-btn @(Model.CurrentPage == 1 ? "active" : "")">1</button>
                        @if (Model.CurrentPage > 3)
                        {
                            <span class="dots">...</span>
                        }
                        @for (int i = Math.Max(2, Model.CurrentPage - 1); i <= Math.Min(Model.TotalPages - 1, Model.CurrentPage + 1); i++)
                        {
                            <button name="currentPage" value="@i" class="pagination-btn @(i == Model.CurrentPage ? "active" : "")">@i</button>
                        }
                        @if (Model.CurrentPage < Model.TotalPages - 2)
                        {
                            <span class="dots">...</span>
                        }
                        @if (Model.TotalPages > 1)
                        {
                            <button name="currentPage" value="@Model.TotalPages" class="pagination-btn @(Model.CurrentPage == Model.TotalPages ? "active" : "")">@Model.TotalPages</button>
                        }
                        @if (Model.CurrentPage < Model.TotalPages)
                        {
                            <button name="currentPage" value="@(Model.CurrentPage + 1)" class="pagination-btn">&gt;</button>
                        }
                    </div>
                </form>
            </div>
        }
                    }
            else
            {
                <div class="vw-no-data">No records found.</div>
            }
        </div>
    </div>
</div>

<!-- Modal -->
<div id="workOrderModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Work Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>
</div>

<!-- jQuery, Select2, scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function () {
        $('.workorder-link').on('click', function (e) {
            e.preventDefault();
            const id = $(this).data('id');
            $('#workOrderModal .modal-body').html('Loading...');
            $.get('@Url.Action("GetWorkOrderDetails", "WorkOrder")', { id: id })
                .done(function (data) {
                    $('#workOrderModal .modal-body').html(data);
                    new bootstrap.Modal($('#workOrderModal')).show();
                })
                .fail(function () {
                    $('#workOrderModal .modal-body').html('<p class="text-danger">Error loading details.</p>');
                });
        });

        $('.select2').select2({
            placeholder: "Search studio...",
            allowClear: true,
            width: '100%'
        });

        $('.dropdown-item').on('click', function (e) {
            e.preventDefault();
            var format = $(this).data('format');
            $('#downloadFormat').val(format);
            if (format === 'pdf') {
                $('#downloadForm').attr('action', '@Url.Action("DownloadPdf", "ViewWork")');
            } else if (format === 'excel') {
                $('#downloadForm').attr('action', '@Url.Action("DownloadExcel", "ViewWork")');
            }
            $('#downloadForm').submit();
        });
    });
</script>

<style>
    .vw-root {
        display: flex;
        min-height: 100vh;
        background: #f3f6fa;
        overflow-x: hidden;
    }

    /* SIDENAV */
    .vw-sidenav {
        position: fixed;
        top: 120px;
        left: 0;
        height: calc(100vh - 120px);
        width: 210px;
        background: #1e3a8a;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: start;
        z-index: 9;
        box-shadow: 1px 0 6px rgba(30,58,138,0.1);
        padding-top: 16px;
    }

    .vw-sidenav-brand {
        font-size: 1rem;
        font-weight: bold;
        padding: 10px 24px 18px;
        letter-spacing: 1px;
    }

    .vw-sidenav-link {
        width: 100%;
        padding: 12px 24px;
        color: #fff;
        font-weight: 500;
        text-decoration: none;
        border-left: 4px solid transparent;
        transition: background 0.2s, border 0.2s;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
    }

        .vw-sidenav-link.active,
        .vw-sidenav-link:hover {
            background: #2742b6;
            color: #fff;
        }

    /* MAIN CONTENT */
    .vw-main {
        margin-left: 210px;
        width: 100%;
        padding: 120px 25px 25px 25px;
        box-sizing: border-box;
    }

    .vw-content-card {
        background: #fff;
        max-width: 910px;
        margin: 0 auto;
        border-radius: 18px;
        box-shadow: 0 4px 16px rgba(30,58,138,0.10);
        padding: 20px;
        box-sizing: border-box;
        min-height: 300px;
    }

    .vw-title {
        margin-bottom: 26px;
        font-size: 1.5rem;
        font-weight: 700;
        color: #22264b;
        letter-spacing: 0.5px;
    }

    /* FORM */
    .vw-form {
        margin-bottom: 25px;
    }

    .vw-form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 32px 20px;
    }

    .vw-form-group {
        display: flex;
        flex-direction: column;
        min-width: 160px;
        max-width: 220px;
        flex: 1 1 140px;
    }

        .vw-form-group label {
            margin-bottom: 4px;
            font-size: 14px;
            font-weight: 600;
            color: #3a3a3a;
        }

        .vw-form-group input,
        .vw-form-group select {
            border: 1px solid #b6cafc;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 14px;
            box-sizing: border-box;
            margin-bottom: 0;
        }

            .vw-form-group input:focus,
            .vw-form-group select:focus {
                border-color: #2563eb;
                outline: none;
            }

    .vw-form-group-btn {
        align-self: flex-end;
        margin-top: 22px;
        min-width: 100px;
    }

    .vw-btn {
        padding: 10px 20px;
        background: #1756be;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        transition: background 0.25s;
        cursor: pointer;
    }

        .vw-btn:hover {
            background: #003ba9;
        }

    /* TABLE */
    .vw-table-scroll {
        width: 100%;
        overflow-x: auto;
    }

    .vw-table {
        width: 100%;
        min-width: 740px;
        border-collapse: collapse;
        background: #fff;
        font-size: 13px;
    }

        .vw-table th,
        .vw-table td {
            border: 1px solid #e6eafd;
            padding: 10px 12px;
            text-align: left;
        }

        .vw-table thead tr {
            background: #1e3a8a;
            color: #fff;
        }

        .vw-table tbody tr:hover td {
            background-color: #f1f7ff;
        }

    .vw-no-data {
        text-align: center;
        font-size: 1.1rem;
        padding: 38px 0 16px;
        color: #888;
    }

    /* PAGINATION */
    .pagination-container {
        margin-top: 24px;
        display: flex;
        justify-content: center;
        margin-bottom: 24px;
    }

    .pagination-form {
        display: flex;
        flex-wrap: wrap;
    }

    .pagination-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 4px 10px;
    }

    .pagination-btn {
        padding: 8px 16px;
        background-color: white;
        border: 1.5px solid #2563eb;
        border-radius: 20px;
        color: #1e3a8a;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        letter-spacing: 0.3px;
        transition: background-color 0.25s ease, color 0.25s ease;
    }

        .pagination-btn:hover {
            background-color: #1d4ed8;
            color: white;
        }

        .pagination-btn.active {
            background-color: #2563eb;
            color: white;
            font-weight: 700;
            cursor: default;
        }

    .dots {
        padding: 8px 12px;
        font-weight: 700;
        color: #999;
    }

    /* RESPONSIVE */
    @@media (max-width: 1100px) {
        .vw-content-card {
            max-width: 96vw;
        }
    }

    @@media (max-width: 900px) {
        .vw-main {
            padding: 32px 6vw;
        }

        .vw-content-card {
            padding: 24px 7vw;
        }

        .vw-form-row {
            gap: 24px 12px;
        }
    }

    @@media (max-width: 700px) {
        .vw-root {
            flex-direction: column;
        }

        .vw-sidenav {
            position: static;
            width: 100vw;
            height: auto;
            flex-direction: row;
            align-items: stretch;
            padding-top: 0;
            box-shadow: none;
            top: 0;
        }

        .vw-sidenav-brand {
            display: none;
        }

        .vw-sidenav-link {
            border-left: none;
            border-bottom: 2px solid transparent;
            flex: 1;
            text-align: center;
        }

            .vw-sidenav-link.active,
            .vw-sidenav-link:hover {
                border-left: none;
                border-bottom: 2px solid #fff;
            }

        .vw-main {
            margin-left: 0;
            padding: 14px 2vw;
        }

        .vw-content-card {
            border-radius: 12px;
            padding: 12px 3vw 14px 3vw;
        }

        .vw-form-row {
            flex-direction: column;
            gap: 10px;
        }

        .vw-table {
            min-width: 420px;
        }
    }
</style>
