@model InternalProj.ViewModel.WorkOrderViewModel

@{
    ViewBag.Title = "View Work Orders";
    var slno = (Model.CurrentPage - 1) * 10 + 1;
}

<div class="common-pages-layout">
    <div class="common-inner-container">
        <h3 class="page-heading">Work Order Details</h3>
        <div class="custom-form-wrapper">
            <form asp-action="Index" method="post" autocomplete="off" class="filter-form">
                <div class="form-group">
                    <label for="studio">Studio:</label>
                    <select id="studio" name="studio" class="form-control select2">
                        <option value="">-- Select Studio --</option>
                        @foreach (var studio in Model.StudioList)
                        {
                            if (studio == Model.StudioFilter)
                            {
                                <option value="@studio" selected>@studio</option>
                            }
                            else
                            {
                                <option value="@studio">@studio</option>
                            }
                        }

                    </select>
                </div>

                <div class="form-group">
                    <label for="fromDate">From Date:</label>
                    <input type="date" id="fromDate" name="fromDate" value="@(Model.FromDateFilter?.ToString("yyyy-MM-dd"))" />
                </div>

                <div class="form-group">
                    <label for="toDate">To Date:</label>
                    <input type="date" id="toDate" name="toDate" value="@(Model.ToDateFilter?.ToString("yyyy-MM-dd"))" />
                </div>

                <div class="form-group">
                    <label for="workTypeId">Work Type:</label>
                    <select asp-for="WorkTypeFilter" asp-items="@(new SelectList(Model.WorkTypes, "WorkTypeId", "TypeName"))" name="workTypeId">
                        <option value="">-- Select Work Type --</option>
                    </select>
                </div>
                <div class="button-cont" style="display: flex; gap: 20px; align-items: center;">
                    <button type="submit"
                            class="common-btn">
                        Search
                    </button>
                    @* <a href="@Url.Action("Index", "ViewWork")" class="btn-refresh">Refresh</a> *@
                </div>
            </form>

            @if (Model.Results != null && Model.Results.Any())
            {
                <table class="workorder-table">
                    <thead>
                        <tr>
                            <th>Sl No</th>
                            <th>Work Order No</th>
                            <th>Studio Name</th>
                            <th>Work Type</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Advance</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Results)
                        {
                            <tr>
                                <td>@(slno++)</td>
                                @* <td>@item.WorkOrderNo</td> *@
                                <td>
                                    <a href="#" class="workorder-link" data-id="@item.WorkOrderId">
                                        @item.WorkOrderNo
                                    </a>
                                </td>

                                <td>@item.Customer?.StudioName</td>
                                <td>@item.WorkType?.TypeName</td>
                                <td>@item.Wdate?.ToString("dd-MM-yyyy")</td>
                                <td>@item.SubTotal.ToString("N2")</td>
                                <td>@item.Advance?.ToString("N2")</td>
                                <td>@((item.SubTotal - (item.Advance ?? 0)).ToString("N2"))</td>
                            </tr>
                        }
                    </tbody>
                </table>
                   <div class="export-dropdown mt-3" style="display: flex; justify-content: flex-end;">
                        <form method="post" asp-controller="ViewWork" target="_blank" id="downloadForm">
                            <input type="hidden" name="studio" value="@Model.StudioFilter" />
                            <input type="hidden" name="fromDate" value="@(Model.FromDateFilter?.ToString("yyyy-MM-dd"))" />
                            <input type="hidden" name="toDate" value="@(Model.ToDateFilter?.ToString("yyyy-MM-dd"))" />
                            <input type="hidden" name="workTypeId" value="@Model.WorkTypeFilter" />
                            <input type="hidden" name="format" id="downloadFormat" value="" />

                            <div class="dropdown">
                                <button class="button dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    Download
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
                                    <li><a class="dropdown-item" href="#" data-format="pdf">Download PDF</a></li>
                                    <li><a class="dropdown-item" href="#" data-format="excel">Download Excel</a></li>
                                </ul>
                            </div>
                        </form>
                    </div>

                @if (Model.TotalPages > 1)
                {
                    <div class="pagination-container">
                        <form asp-action="Index" method="post" class="pagination-form">
                            <input type="hidden" name="studio" value="@Context.Request.Form["studio"]" />
                            <input type="hidden" name="fromDate" value="@Context.Request.Form["fromDate"]" />
                            <input type="hidden" name="toDate" value="@Context.Request.Form["toDate"]" />
                            <input type="hidden" name="workTypeId" value="@Context.Request.Form["workTypeId"]" />

                            <div class="pagination-buttons">
                                @if (Model.CurrentPage > 1)
                                {
                                    <button name="currentPage" value="@(Model.CurrentPage - 1)" class="pagination-btn">&lt;</button>
                                }

                                <button name="currentPage" value="1" class="pagination-btn @(Model.CurrentPage == 1 ? "active" : "")">1</button>

                                @if (Model.CurrentPage > 3)
                                {
                                    <span class="dots">...</span>
                                }

                                @for (int i = Math.Max(2, Model.CurrentPage - 1); i <= Math.Min(Model.TotalPages - 1, Model.CurrentPage + 1); i++)
                                {
                                    <button name="currentPage" value="@i" class="pagination-btn @(i == Model.CurrentPage ? "active" : "")">@i</button>
                                }

                                @if (Model.CurrentPage < Model.TotalPages - 2)
                                {
                                    <span class="dots">...</span>
                                }

                                @if (Model.TotalPages > 1)
                                {
                                    <button name="currentPage" value="@Model.TotalPages" class="pagination-btn @(Model.CurrentPage == Model.TotalPages ? "active" : "")">@Model.TotalPages</button>
                                }

                                @if (Model.CurrentPage < Model.TotalPages)
                                {
                                    <button name="currentPage" value="@(Model.CurrentPage + 1)" class="pagination-btn">&gt;</button>
                                }
                            </div>
                        </form>
                    </div>
                }
            }
            else
            {
                <p>No records found.</p>
            }
        </div>
    </div>
</div>

<div id="workOrderModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Work Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Content loads here -->
            </div>
        </div>
    </div>
</div>

<!-- Load jQuery first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Then your custom script -->
<script>
    $(document).ready(function () {
        $('.workorder-link').on('click', function (e) {
            e.preventDefault();
            const id = $(this).data('id');
            $('#workOrderModal .modal-body').html('Loading...');

            $.get('@Url.Action("GetWorkOrderDetails", "WorkOrder")', { id: id })
                .done(function (data) {
                    $('#workOrderModal .modal-body').html(data);
                    new bootstrap.Modal($('#workOrderModal')).show();
                })
                .fail(function () {
                    $('#workOrderModal .modal-body').html(
                        '<p class="text-danger">Error loading details.</p>'
                    );
                });
        });

        $('.select2').select2({
            placeholder: "Search studio...",
            allowClear: true,
            width: '100%'
        });

    });
</script>

<script>
    $(document).ready(function () {
        $('.dropdown-item').on('click', function (e) {
            e.preventDefault();
            var format = $(this).data('format');
            $('#downloadFormat').val(format);

            // Set the form action depending on selection
            if (format === 'pdf') {
                $('#downloadForm').attr('action', '@Url.Action("DownloadPdf", "ViewWork")');
            } else if (format === 'excel') {
                $('#downloadForm').attr('action', '@Url.Action("DownloadExcel", "ViewWork")');
            }

            $('#downloadForm').submit();
        });
    });
</script>

<style>

    /* Form styling */
    .filter-form {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
        align-items: flex-end;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
        max-width: 220px;
    }

    label {
        font-weight: 600;
        margin-bottom: 6px;
        color: #444;
    }

    input[type="text"],
    input[type="date"],
    select {
        padding: 8px 10px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        transition: border-color 0.3s ease;
    }

        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #2563eb;
            outline: none;
        }

    button {
        padding: 10px 20px;
        font-size: 14px;
        background-color: #1e3a8a;
        border: none;
        color: white;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        align-self: center;
        font-weight: 500;
    }

        button:hover {
            /* background-color: #9007a8; */
        }

    /* Table styling */
    .workorder-table {
        width: 100%;
        border-collapse: collapse;
        box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
        background-color: white;
        font-size: 13px;
    }

        .workorder-table th,
        .workorder-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: left;
        }

        .workorder-table thead {
            background-color: #1e3a8a;
            color: white;
            font-weight: 600;
        }

        .workorder-table tbody tr:hover {
            background-color: #f1f7ff;
        }

    /* Responsive for small screens */
    @@media (max-width: 700px) {
        .filter-form {
            flex-direction: column;
            align-items: stretch;
        }

        .form-group {
            max-width: 100%;
        }

        button {
            width: 100%;
        }
    }

    /* .btn-refresh {
        padding: 10px 20px;
        text-decoration: none;
        font-size: 14px;
        background-color: #07ad33;
        border: none;
        color: white;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        align-self: center;
        font-weight: 500;
    }

        .btn-refresh:hover {
            background-color: #248c40;
            color: white;
        } */

    .button-cont {
        display: flex;
    }

    .pagination-container {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        margin-bottom: 40px;
    }

    .pagination-form {
        display: flex;
        flex-wrap: wrap;
    }

    .pagination-buttons {
        display: flex;
        gap: 6px;
        align-items: center;
        padding: 4px 10px;
    }

    .pagination-btn {
        padding: 6px 16px;
        background-color: white;
        border: 1px solid #2563eb;
        border-radius: 20px;
        color: #1e3a8a;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

        .pagination-btn:hover {
            background-color: #1d4ed8;
            color: white;
        }

        .pagination-btn.active {
            background-color: #2563eb;
            color: white;
            font-weight: bold;
        }

    .dots {
        padding: 6px;
        font-weight: bold;
        color: #999;
    }

</style>
