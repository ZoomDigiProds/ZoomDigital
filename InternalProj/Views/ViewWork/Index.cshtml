@model InternalProj.ViewModel.WorkOrderViewModel

@{
    ViewBag.Title = "View Work Orders";
    var slno = (Model.CurrentPage - 1) * 10 + 1;
    var counter = slno;
}

<div class="common-pages-layout">
    <div class="common-inner-container">
        <h3 class="page-heading">View Work Order</h3>

        <form asp-action="Search" method="post" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8 items-end">
            <div>
                <label for="studio" class="block text-gray-700 text-sm font-medium mb-1">Studio</label>
                <select id="studio" name="studio"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Select Studio --</option>
                    @foreach (var studio in Model.StudioList)
                    {
                        var isSelected = studio == Model.StudioFilter ? "selected" : "";
                        @Html.Raw($"<option value=\"{studio}\" {isSelected}>{studio}</option>")
                    }
                </select>
            </div>
            <div>
                <label for="fromDate" class="block text-gray-700 text-sm font-medium mb-1">From Date</label>
                <input type="date" id="fromDate" name="fromDate"
                       value="@(Model.FromDateFilter?.ToString("yyyy-MM-dd"))"
                       class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
            <div>
                <label for="toDate" class="block text-gray-700 text-sm font-medium mb-1">To Date</label>
                <input type="date" id="toDate" name="toDate"
                       value="@(Model.ToDateFilter?.ToString("yyyy-MM-dd"))"
                       class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
            <div>
                <label for="workTypeId" class="block text-gray-700 text-sm font-medium mb-1">Work Type</label>
                <select asp-for="WorkTypeFilter"
                        asp-items="@(new SelectList(Model.WorkTypes, "WorkTypeId", "TypeName"))"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Select --</option>
                </select>
            </div>
            <div class="flex space-x-2">
                <button type="submit"
                        class="common-btn">
                    Search
                </button>

            </div>
        </form>

        <div id="resultsTableContainer">
            @await Html.PartialAsync("_WorkOrderResultsPartial", Model)
        </div>

    </div>

    <div id="workOrderModal"
         class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-40 overflow-auto">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl mx-auto shadow-xl relative my-16">
            <div class="flex items-center justify-between border-b pb-2 mb-4">
                <h5 class="text-lg font-bold">Work Order Details</h5>
                <button type="button"
                        class="text-gray-500 hover:text-red-500 text-2xl font-bold"
                        id="modalCloseBtn">
                    &times;
                </button>
            </div>
            <div id="workOrderModalContent" class="min-h-[100px] flex items-center justify-center text-gray-700">
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {

        var pageCache = {};

        function loadPage(page) {
            if (pageCache[page]) {
                $('#resultsTableContainer').html(pageCache[page]);
                attachLinkAndPaginationHandlers();
            } else {
                $('#resultsTableContainer').html('<p class="text-center py-6 text-gray-500">Loading...</p>');

                var data = {
                    studio: $('select[name="studio"]').val(),
                    fromDate: $('input[name="fromDate"]').val(),
                    toDate: $('input[name="toDate"]').val(),
                    workTypeId: $('select[name="workTypeId"]').val(),
                    isSearch: true,
                    currentPage: page
                };

                $.get('@Url.Action("Index", "ViewWork")', data)
                    .done(function (html) {
                        pageCache[page] = html;
                        $('#resultsTableContainer').html(html);
                        attachLinkAndPaginationHandlers();
                    })
                    .fail(function () {
                        $('#resultsTableContainer').html('<p class="text-red-500 text-center py-6">Error loading page data.</p>');
                    });
            }
        }

        function attachLinkAndPaginationHandlers() {
            $('#resultsTableContainer').find('button.ajaxPageBtn').off('click').on('click', function (e) {
                e.preventDefault();
                var page = $(this).val();
                loadPage(page);
            });

            $('#resultsTableContainer').find('a[data-id]').off('click').on('click', function (e) {
                e.preventDefault();
                var id = $(this).data('id');
                $('#workOrderModalContent').html('Loading...');
                $('#workOrderModal').removeClass('hidden').addClass('flex');
                $.get('@Url.Action("GetWorkOrderDetails", "WorkOrder")', { id: id })
                    .done(function (data) {
                        $('#workOrderModalContent').html(data);
                    })
                    .fail(function () {
                        $('#workOrderModalContent').html('<p class="text-red-500">Error loading details.</p>');
                    });
            });
        }

        attachLinkAndPaginationHandlers();

        $('#modalCloseBtn, #workOrderModal').on('click', function (e) {
            if (e.target === this) {
                $('#workOrderModal').addClass('hidden').removeClass('flex');
            }
        });

        $('form[asp-action="Search"]').on('submit', function () {
            pageCache = {}; // clear cache on new search
        });
    });
</script>