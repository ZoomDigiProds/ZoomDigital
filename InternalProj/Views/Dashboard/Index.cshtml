@model List<InternalProj.ViewModel.WorkOrderSummaryViewModel>

@{
    ViewData["Title"] = "Zoom Digital Press";
}

@* <link rel="stylesheet" href="~/css/LayoutPage.css" asp-append-version="true" /> *@

<div class="common-pages-layout">
    <div class="common-inner-container">
        <h3 class="page-heading">Dashboard Overview</h3>
@if (TempData["ErrorMessage"] != null)
{
    <div id="editError" class="bg-red-100 text-red-800 rounded-lg p-3 text-center mb-4">
        @TempData["ErrorMessage"]
    </div>
}

<script>
    setTimeout(() => {
        const editError = document.getElementById('editError');
        if (editError) {
            editError.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            setTimeout(() => editError.remove(), 600);
        }
    }, 5000);
</script>

<div class="container mx-auto px-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        @for (int i = 1; i <= 4; i++)
        {
            <div class="card-wrapper">
                <div class="dashboard-card bg-white rounded-lg shadow p-4 flex flex-col justify-between min-h-[200px]">
                    <div class="text-center">
                        @if (i == 1)
                        {
                            <h5 class="text-xl font-semibold mb-4">Work Details</h5>
                            <div id="box1Content">
                                <div id="workOrderSummaryContainer">
                                    @await Html.PartialAsync("_WorkOrderSummaryPartial", Model)
                                </div>
                            </div>
                        }
                        else if (i == 2)
                        {
                            <h5 class="text-xl font-semibold mb-4">Daily Transactions</h5>
                            <div id="box2Content">
                                <div id="dailyTransactionSummaryContainer" class="text-gray-600">
                                    Loading...
                                </div>
                            </div>
                        }
                        else
                        {
                            <p class="text-gray-700">Placeholder for content</p>
                        }
                    </div>

                    <div class="mt-4 text-center">
                        <button type="button"
                                data-box="@i"
                                class="common-btn">
                            View
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<div class="modal fade" id="workOrderModal" tabindex="-1" aria-labelledby="workOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content rounded-lg shadow-lg">
            <div class="modal-header flex justify-between items-center p-4 border-b border-gray-200">
                <h5 class="modal-title text-xl font-semibold" id="workOrderModalLabel">Work Orders</h5>
                <button type="button" class="btn-close text-gray-600 hover:text-gray-900" data-bs-dismiss="modal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body p-6" id="modalContent">
                Loading...
            </div>
        </div>
    </div>
</div>
</div>
</div>


@section Scripts {
    <script>
        $(document).on('click', '.common-btn', function () {
            const boxId = parseInt($(this).data('box'));
            let url = '';
            let modalTitle = '';

            if (boxId === 2) {
                url = '/DailyTransaction/PaginatedTransactionsPartial?page=1';
                modalTitle = 'Today\'s Transactions';
            } else {
                url = `/Dashboard/GetBoxContent?id=${boxId}`;
                modalTitle = 'Work Orders';
            }

            console.log("boxId:", boxId, "url:", url);

            $('#workOrderModalLabel').text(modalTitle);

            $.get(url, function (data) {
                $('#modalContent').html(data);
                $('#workOrderModal').modal('show');
            });
        });

        window.refreshDashboardData = function () {
            $.get('/Dashboard/GetWorkOrderSummary', function (html) {
                $('#workOrderSummaryContainer').html(html);
            });
        };

        window.refreshTransactionData = function () {
            $.get('/Dashboard/DailyTransactionSummaryPartial', function (html) {
                $('#dailyTransactionSummaryContainer').html(html);
            });
        };

        // Trigger refreshes every few seconds
        setInterval(refreshDashboardData, 10000);
        setInterval(refreshTransactionData, 500);

        // Storage event: sync between tabs
        window.addEventListener('storage', function (e) {
            if (e.key === 'workOrderUpdated') {
                refreshDashboardData();
            }
        });

        // Ensure modal cleanup
        $('#workOrderModal').on('hidden.bs.modal', function () {
            $('body').removeClass('modal-open');
            $('.modal-backdrop').remove();
        });
    </script>
}

<style>
    .dashboard-card {
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .card-wrapper {
        margin-bottom: 1.25rem; /* 20px */
    }
</style>
