@model InternalProj.ViewModel.ReceiptViewModel

@{
    ViewData["Title"] = "Create Receipt";
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success text-center" id="success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger text-center" id="error">@TempData["Error"]</div>
}

<script>
    setTimeout(() => {
        $('#success').fadeOut('slow');
    }, 5000);
</script>

<script>
    setTimeout(() => {
        $('#error').fadeOut('slow');
    }, 5000);
</script>

@section Styles {
    <link rel="stylesheet" href="~/css/Receipt.css" asp-append-version="true" />
}
<h2 class="text-center">Receipt</h2>

<div style="font-size: 0.9rem;">
    <form asp-action="Create" method="post">
        <div class="row mb-3">
            <div class="col-md-2">
                <label class="form-label">Receipt No</label>
                <input class="form-control" value="@Model.ReceiptNo" readonly />
            </div>
            <div class="col-md-2">
                <label class="form-label">Receipt Date</label>
                <input asp-for="Receipt.ReceiptDate" class="form-control" type="date" readonly />
            </div>
            <div class="col-md-2">
                <label class="form-label">Payment Type</label>
                <select asp-for="Receipt.ModeId"
                        asp-items="@(new SelectList(Model.ModeOfPayments, "ModeId", "ModeType"))"
                        class="form-control">
                    <option value="">-- Select --</option>
                </select>

            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">Select By</label>
                <select id="selectType" class="form-control">
                    <option value="customer">Customer Name</option>
                    <option value="studio">Studio Name</option>
                </select>
            </div>

            <div class="col-md-3" id="customerNameBox">
                <label class="form-label">Customer Name</label>
                <select class="form-control" id="customerSelectByName">
                    <option value="">-- Select Customer --</option>
                   @foreach (var c in Model.Customers)
                    {
                        var selected = c.Id == Model.Receipt.CustomerId ? "selected" : "";
                        @:<option value="@c.Id" @selected>@c.FirstName @c.LastName</option>
                    }

                </select>
            </div>

            <div class="col-md-3 d-none" id="studioNameBox">
                <label class="form-label">Studio Name</label>
                <select class="form-control" id="customerSelectByStudio">
                    <option value="">-- Select Studio --</option>
                    @foreach (var c in Model.Customers)
                    {
                        var selected = c.Id == Model.Receipt.CustomerId ? "selected" : "";
                       @:<option value="@c.Id" @selected>@c.StudioName</option>
                    }

                </select>
            </div>

            <div class="col-md-6 text-end mt-3 ms-auto">
                <label class="form-label">Total Balance:</label>
                <span style="font-weight: bold; font-size: 1.1rem; color: #5190f5;">
                    ₹@Model.TotalBalance.ToString("N2")
                </span>
            </div>


        </div>

        <h5 class="mt-4">Work Orders</h5>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Select</th>
                    <th>WorkOrder No</th>
                    <th>Date</th>
                    <th>Net</th>
                    <th>Balance</th>
                    <th>Pay Now</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in Model.PagedWorkOrders)
                {
                    <tr>
                        <td>
                            <input type="radio" name="selectedWorkOrder"
                                   data-id="@order.WorkOrderId"
                                   data-net="@order.SubTotal" />
                        </td>
                        <td>@order.WorkOrderNo</td>
                        <td>@order.Wdate?.ToString("yyyy-MM-dd")</td>
                        <td>@order.SubTotal.ToString("N2")</td>
                        <td>@order.Balance.ToString("N2")</td>
                        <td><input type="number" class="form-control payNowInput" disabled /></td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="mt-4 text-center">
            <button type="submit" class="btn btn-primary">Submit</button>
        </div>

        <input type="hidden" asp-for="Receipt.CustomerId" id="Receipt_CustomerId" />
        <input type="hidden" asp-for="Receipt.WorkOrderId" id="WorkOrderId" />
        <input type="hidden" asp-for="Receipt.NetAmount" id="NetAmount" />
        <input type="hidden" asp-for="Receipt.CurrentAmount" id="CurrentAmount" />
    </form>

    @*     @if (Model.TotalPages > 1)
    {
        <div class="pagination-container mt-3">
            <form asp-action="Create" method="get" class="d-inline">
                <input type="hidden" name="customerId" value="@Model.Receipt.CustomerId" />

                @if (Model.CurrentPage > 1)
                {
                    <button type="submit" name="currentPage" value="@(Model.CurrentPage - 1)" class="pagination-btn">&lt;</button>
                }

                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <button type="submit" name="currentPage" value="@i" class="pagination-btn @(i == Model.CurrentPage ? "active" : "")">@i</button>
                }

                @if (Model.CurrentPage < Model.TotalPages)
                {
                    <button type="submit" name="currentPage" value="@(Model.CurrentPage + 1)" class="pagination-btn">&gt;</button>
                }
            </form>
        </div>
    }
 *@

 @if (Model.TotalPages > 1)
{
    <div class="pagination-container text-center mt-3">
        <form asp-action="Create" method="get" class="d-inline-flex flex-wrap justify-content-center gap-1">
            <input type="hidden" name="customerId" value="@Model.Receipt.CustomerId" />

            @if (Model.CurrentPage > 1)
            {
                <button type="submit" name="currentPage" value="@(Model.CurrentPage - 1)" class="pagination-btn">&lt;</button>
            }

            <button type="submit" name="currentPage" value="1" class="pagination-btn @(Model.CurrentPage == 1 ? "active" : "")">1</button>

            @if (Model.CurrentPage > 3)
            {
                <span class="px-2 align-self-center">...</span>
            }

            @for (int i = Math.Max(2, Model.CurrentPage - 1); i <= Math.Min(Model.TotalPages - 1, Model.CurrentPage + 1); i++)
            {
                <button type="submit" name="currentPage" value="@i" class="pagination-btn @(i == Model.CurrentPage ? "active" : "")">@i</button>
            }

            @if (Model.CurrentPage < Model.TotalPages - 2)
            {
                <span class="px-2 align-self-center">...</span>
            }

            @if (Model.TotalPages > 1)
            {
                <button type="submit" name="currentPage" value="@Model.TotalPages" class="pagination-btn @(Model.CurrentPage == Model.TotalPages ? "active" : "")">@Model.TotalPages</button>
            }

            @if (Model.CurrentPage < Model.TotalPages)
            {
                <button type="submit" name="currentPage" value="@(Model.CurrentPage + 1)" class="pagination-btn">&gt;</button>
            }
        </form>
    </div>
}


</div>       

@section Scripts {
    <script>
        $(document).ready(function () {
            const currentId = $("#Receipt_CustomerId").val();

            // Restore previously selected ModeId (from sessionStorage)
            const savedMode = sessionStorage.getItem("selectedModeId");
            if (savedMode) {
                $("select[name='Receipt.ModeId']").val(savedMode);
                sessionStorage.removeItem("selectedModeId");
            }

            // Restore previously selected selectType if available
            const savedSelectType = sessionStorage.getItem("selectedSelectType");
            if (savedSelectType) {
                $("#selectType").val(savedSelectType).trigger("change");
                sessionStorage.removeItem("selectedSelectType");

                if (savedSelectType === "studio") {
                    $("#customerSelectByStudio").val(currentId);
                } else {
                    $("#customerSelectByName").val(currentId);
                }
            } else {
                // Default fallback if no sessionStorage
                $("#selectType").trigger("change");

                const studioOption = $("#customerSelectByStudio option[value='" + currentId + "']").length > 0;
                if (studioOption) {
                    $("#customerSelectByStudio").val(currentId);
                } else {
                    $("#customerSelectByName").val(currentId);
                }
            }
        });

        // Toggle dropdown boxes based on selectType
        $("#selectType").on("change", function () {
            const type = $(this).val();
            const isStudio = type === "studio";

            $("#studioNameBox").toggleClass("d-none", !isStudio);
            $("#customerNameBox").toggleClass("d-none", isStudio);
        });

        // When customer/studio changes, update hidden input and reload with GET
        $("#customerSelectByName, #customerSelectByStudio").on("change", function () {
            const customerId = $(this).val();
            if (!customerId) return;

            // Update hidden field (so submit will work)
            $("#Receipt_CustomerId").val(customerId);

            // Save selected ModeId and SelectType to restore after reload
            const selectedModeId = $("select[name='Receipt.ModeId']").val();
            const selectedType = $("#selectType").val();

            sessionStorage.setItem("selectedModeId", selectedModeId);
            sessionStorage.setItem("selectedSelectType", selectedType);

            const url = new URL(window.location.href);
            url.searchParams.set("customerId", customerId);
            url.searchParams.set("currentPage", "1");
            window.location.href = url.toString();
        });

        // When a work order is selected
        $(document).on('change', 'input[name="selectedWorkOrder"]', function () {
            $("input.payNowInput").prop("disabled", true).val('');
            const row = $(this).closest("tr");
            row.find(".payNowInput").prop("disabled", false);
            $("#WorkOrderId").val($(this).data("id"));
            $("#NetAmount").val($(this).data("net"));
        });

        // Capture entered payment amount
        $(document).on('input', '.payNowInput', function () {
            const amt = parseFloat($(this).val()) || 0;
            $("#CurrentAmount").val(amt);
        });
    </script>
}

<style>
    table.table {
        font-size: 0.9rem;
        width: 100%;
        margin: 0 auto;
    }

    .table td {
        padding: 3px 6px;
        vertical-align: middle;
    }

    .table th {
        padding:10px;
        vertical-align: middle;
    }

    .pagination-container {
    text-align: center;
    margin-top: 10px;
}

.pagination-btn {
    font-size: 0.85rem;
    padding: 4px 12px;
    margin: 2px;
    border: 1px solid #64126b;
    background-color: #64126b;
    border-radius: 20px;
    cursor: pointer;
    color: white;
}

.pagination-btn.active {
    background-color: #64126b;
    color: white;
}

.pagination-btn:hover {
    background-color: #500d57;
}

</style>
